<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Electron Dock</title>
</head>
<body>
  <webview src="http://www.dmm.com/netgame/social/-/gadgets/=/app_id=854854/" partition="persist:kc"
    width="800" minheight="480" plugins autosize="on" nodeintegration style="width: 800px; height: 480px"></webview>
  <script>
    const Immutable = require('immutable');

    let webview = document.querySelector('webview');
    let firstLoad = true;
    let gameUrl;
    let gameSession;
    let debuggerAttached = false;

    webview.addEventListener('dom-ready', function () {
      var webContents;
      var webSession;

      console.log('webview ready', arguments);

      webContents = webview.getWebContents();
      webSession = webContents.session;

      if (!debuggerAttached) {
        try {
          webContents.debugger.attach("1.1");
          debuggerAttached = true;
        }
        catch (err) {
          console.log("Debugger attach failed : ", err);
        }

        webContents.debugger.on('detach', function (event, reason) {
          console.log("Debugger detached due to: ", reason);
        });

        webContents.debugger.on('message', function (event, method, params) {
          if (method == 'Network.responseReceived') {
            webContents.debugger.sendCommand('Network.getResponseBody', {
              requestId: params.requestId
            }, function (err, result) {
              if (!err.message && /.*\/kcsapi/.test(params.response.url)) {
                console.log('Network.getResponseBody');
                console.log('URL\t\t=>', params.response.url.replace(/.*\/kcsapi/, ''));
                console.log('event\t=>', JSON.parse(JSON.stringify(event)));
                console.log('params\t=>', JSON.parse(JSON.stringify(params)));
              }
            });
          }
        });

        webContents.debugger.sendCommand("Network.enable");
      }

      webSession.webRequest.onCompleted(function (details) {
        if (/kcs\/mainD2/.test(details.url) && firstLoad) {
          gameSession = webSession;

          console.log('Found game SWF: ', details.url);
          gameUrl = details.url;
          firstLoad = false;

          webview.loadURL(gameUrl);
        }
      });

      let cklg = {
        expires: new Date(),
        domain: '.dmm.com',
        path: '/'
      };

      webContents.executeJavaScript([
        'document.cookie = "cklg=welcome;expires=Sun, 09 Feb 2019 09:00:09 GMT;domain=.dmm.com;path=/";',
        'document.cookie = "cklg=welcome;expires=Sun, 09 Feb 2019 09:00:09 GMT;domain=.dmm.com;path=/netgame/";',
        'document.cookie = "cklg=welcome;expires=Sun, 09 Feb 2019 09:00:09 GMT;domain=.dmm.com;path=/netgame_s/";',
        'document.cookie = "ckcy=1;expires=Sun, 09 Feb 2019 09:00:09 GMT;domain=.dmm.com;path=/";',
        'document.cookie = "ckcy=1;expires=Sun, 09 Feb 2019 09:00:09 GMT;domain=.dmm.com;path=/netgame/";',
        'document.cookie = "ckcy=1;expires=Sun, 09 Feb 2019 09:00:09 GMT;domain=.dmm.com;path=/netgame_s/";'
      ].join('\n'));
    });
  </script>
</body>
</html>